#include <iostream>
#include <assert.h>
#include <Eigen/Dense>

#include "Conv.h"
#include "Helper.h"

void initializeInputs();

Eigen::Tensor<float, 4> input_image(1, 1, 14, 14);
Eigen::Tensor<float, 4> expected_result(1, 2, 14, 14);

Eigen::Tensor<float, 4> weights(2, 1, 3, 3);

Eigen::Tensor<float, 4> error_next(1, 2, 14, 14);
Eigen::Tensor<float, 4> expected_error_prev(1, 1, 14, 14);

Eigen::Tensor<float, 4> expected_gradient_bias(1, 1, 1, 2);
Eigen::Tensor<float, 4> expected_gradient_weights(2, 1, 3, 3);


 void testConvForward2D(Eigen::Tensor<float, 4> bias, int times = 1) {
    Conv conv(2, 1, 3, 1);
    conv.setWeights(weights);
    conv.setBias(bias);

    auto exp_dims = expected_result.dimensions();

    // Adding bias to expected result
    Eigen::Tensor<float, 4> expected_result_bias(expected_result);
    for (int i = 0; i < exp_dims[0]; i++) {
        for (int j = 0; j < exp_dims[1]; j++) {
            for (int x = 0; x < exp_dims[2]; x++) {
                for (int y = 0; y < exp_dims[3]; y++) {
                    expected_result_bias(i, j, x, y) += bias(j);
                }
            }
        }
    }

    // Performing forward pass
    std::shared_ptr<Eigen::Tensor<float, 4>> output;
    for (int i = 0; i < times; i++) {
        output = conv.forward(std::make_shared<Eigen::Tensor<float, 4>>(input_image));
    }

    float diff = ((Eigen::Tensor<float, 0>)(expected_result_bias - *output).abs().sum())(0);
    
    assert(("FAILED", diff < 1e-7));
    std::cout << "PASSED" << std::endl;
 }


 void testConvBackward2D(int times = 1) {
     Conv conv(2, 1, 3, 1);
     conv.setWeights(weights);
     Eigen::Tensor<float, 4> bias(1, 1, 1, 2);
     bias.setValues({ {{{ 0.5, 1 }}} });
     conv.setBias(bias);

     
     // Performing backward pass
     std::shared_ptr<Eigen::Tensor<float, 4>> error_prev;
     for (int i = 0; i < times; i++) {
         conv.forward(std::make_shared<Eigen::Tensor<float, 4>>(input_image));
         error_prev = conv.backward(std::make_shared<Eigen::Tensor<float, 4>>(error_next));
     }

     float diff = ((Eigen::Tensor<float, 0>)(expected_error_prev - *error_prev).abs().sum())(0);
     assert(("Computation of error with respect to the previous layer is not correct.", diff < 1e-7));

     diff = ((Eigen::Tensor<float, 0>)(expected_gradient_bias - conv.getGradientBias()).abs().sum())(0);
     assert(("Computation of error with respect to the bias is not correct.", diff < 1e-7));

     diff = ((Eigen::Tensor<float, 0>)(expected_gradient_weights - conv.getGradientWeights()).abs().sum())(0);
     assert(("Computation of error with respect to the weights is not correct.", diff < 1e-7));

     std::cout << "PASSED" << std::endl;
 }


int main() {
    initializeInputs();
    Eigen::Tensor<float, 4> zero_bias(1, 1, 1, 2);
    Eigen::Tensor<float, 4> non_zero_bias(1, 1, 1, 2);
    zero_bias.setValues({ {{{ 0., 0. }}} });
    non_zero_bias.setValues({ {{{ 0.5, -0.5 }}} });

    std::cout << "------ CONVOLUTION LAYER TESTS ------" << std::endl;
    std::cout << "Convolution forward without bias: ";
	testConvForward2D(zero_bias);

    std::cout << "Convolution forward with bias: ";
	testConvForward2D(non_zero_bias);

    std::cout << "Convolution forward multiple times: ";
	testConvForward2D(non_zero_bias, 3);

    std::cout << "Convolution backward one time: ";
    testConvBackward2D();

    std::cout << "Convolution backward multiple times: ";
    testConvBackward2D(3);

    // TODO: Pooling Layer tests
    return 0;
}


void initializeInputs() {
    input_image.setValues({ {{
     {1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. },
     {1. , 1. , 1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1. , 1. , 1.},
     {1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1.},
     {1. , 1. , 1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1. , 1. , 1.},
     {1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1.}}} });


    expected_result.setValues({{
       {{ 1.5, 0., 0., 0., -0.25, -0.25, 0., 0., 0.25, 0.25, 0., 0., 0., -1.5 },
        {2., 0., -0.25, -0.25, -0.5, -0.5, 0., 0., 0.5, 0.5, 0.25, 0.25, 0., -2.},
        {2., -0.25, -0.75, -0.5, -0.25, -0.25, 0., 0., 0.25, 0.25, 0.5, 0.75, 0.25, -2.},
        {2., -0.75, -1., -0.25, 0., 0., 0., 0., 0., 0., 0.25, 1., 0.75, -2.},
        {1.75, -1., -0.75, 0., -0.25, -0.25, 0., 0., 0.25, 0.25, 0., 0.75, 1., -1.75},
        {1.25, -1., -0.25, 0., -0.75, -0.75, 0., 0., 0.75, 0.75, 0., 0.25, 1., -1.25},
        {1., -1., 0., 0., -1., -1., 0., 0., 1., 1., 0., 0., 1., -1.},
        {1., -1., 0., 0., -1., -1., 0., 0., 1., 1., 0., 0., 1., -1.},
        {1.25, -1., -0.25, 0., -0.75, -0.75, 0., 0., 0.75, 0.75, 0., 0.25, 1., -1.25},
        {1.75, -1., -0.75, 0., -0.25, -0.25, 0., 0., 0.25, 0.25, 0., 0.75, 1., -1.75},
        {2., -0.75, -1., -0.25, 0., 0., 0., 0., 0., 0., 0.25, 1., 0.75, -2.},
        {2., -0.25, -0.75, -0.5, -0.25, -0.25, 0., 0., 0.25, 0.25, 0.5, 0.75, 0.25, -2.},
        {2., 0., -0.25, -0.25, -0.5, -0.5, 0., 0., 0.5, 0.5, 0.25, 0.25, 0., -2.},
        {1.5, 0., 0., 0., -0.25, -0.25, 0., 0., 0.25, 0.25, 0., 0., 0., -1.5}},

       {{ 1.5, 2., 2., 2., 1.75, 1.25, 1., 1., 1.25, 1.75, 2., 2., 2., 1.5 },
        {0., 0., -0.25, -0.75, -1., -1., -1., -1., -1., -1., -0.75, -0.25, 0., 0.},
        {0., -0.25, -0.75, -1., -0.75, -0.25, 0., 0., -0.25, -0.75, -1., -0.75, -0.25, 0.},
        {0., -0.25, -0.5, -0.25, 0., 0., 0., 0., 0., 0., -0.25, -0.5, -0.25, 0.},
        {-0.25, -0.5, -0.25, 0., -0.25, -0.75, -1., -1., -0.75, -0.25, 0., -0.25, -0.5, -0.25},
        {-0.25, -0.5, -0.25, 0., -0.25, -0.75, -1., -1., -0.75, -0.25, 0., -0.25, -0.5, -0.25},
        {0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.},
        {0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.},
        {0.25, 0.5, 0.25, 0., 0.25, 0.75, 1., 1., 0.75, 0.25, 0., 0.25, 0.5, 0.25},
        {0.25, 0.5, 0.25, 0., 0.25, 0.75, 1., 1., 0.75, 0.25, 0., 0.25, 0.5, 0.25},
        {0., 0.25, 0.5, 0.25, 0., 0., 0., 0., 0., 0., 0.25, 0.5, 0.25, 0.},
        {0., 0.25, 0.75, 1., 0.75, 0.25, 0., 0., 0.25, 0.75, 1., 0.75, 0.25, 0.},
        {0., 0., 0.25, 0.75, 1., 1., 1., 1., 1., 1., 0.75, 0.25, 0., 0.},
        {-1.5, -2., -2., -2., -1.75, -1.25, -1., -1., -1.25, -1.75, -2., -2., -2., -1.5}}}});


    weights.setValues({ {{{-0.5, 0, 0.5}, {-1, 0, 1}, {-0.5, 0, 0.5}}},
                        {{{-0.5, -1, -0.5}, {0, 0, 0}, {0.5, 1, 0.5}}} });


    error_next.setValues({{
    {{1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1.},
     {1. , 1. , 1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1. , 1. , 1.},
     {1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1.},
     {1. , 1. , 1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1. , 1. , 1.},
     {1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1.}},
        
    {{1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1.},
     {1. , 1. , 1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1. , 1. , 1.},
     {1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 0.5, 0.5, 0.5, 0.5, 0. , 0. , 0. , 0. , 0.5, 0.5, 0.5, 0.5, 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1.},
     {1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1.},
     {1. , 1. , 1. , 1. , 1. , 0.5, 0.5, 0.5, 0.5, 1. , 1. , 1. , 1. , 1.},
     {1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1. , 1.}}}});

    error_next = error_next * 0.25f;
    error_next.chip(0, 0).chip(1, 0) = error_next.chip(0, 0).chip(1, 0) * -1.f;


    expected_error_prev.setValues({{{
        { 0., 0.5, 0.5, 0.5, 0.5, 0.375, 0.25, 0.25, 0.25, 0.375, 0.5, 0.5, 0.5, 0.75 },
        {-0.5, 0., 0., -0.125, -0.125, -0.125, -0.25, -0.25, -0.375, -0.375, -0.25, -0.125, 0., 0.5},
        {-0.5, 0., 0., -0.125, -0.125, 0., 0., 0., -0.125, -0.25, -0.375, -0.375, -0.125, 0.5},
        {-0.5, 0.125, 0.125, 0., 0., 0., 0., 0., 0., 0., -0.125, -0.375, -0.25, 0.5},
        {-0.5, 0.125, 0.125, 0., 0., -0.125, -0.25, -0.25, -0.25, -0.125, 0., -0.25, -0.375, 0.375},
        {-0.375, 0.125, 0., 0., 0.125, 0., -0.25, -0.25, -0.375, -0.25, 0., -0.125, -0.375, 0.25},
        {-0.25, 0.25, 0., 0., 0.25, 0.25, 0., 0., -0.25, -0.25, 0., 0., -0.25, 0.25},
        {-0.25, 0.25, 0., 0., 0.25, 0.25, 0., 0., -0.25, -0.25, 0., 0., -0.25, 0.25},
        {-0.25, 0.375, 0.125, 0., 0.25, 0.375, 0.25, 0.25, 0., -0.125, 0., 0., -0.125, 0.375},
        {-0.375, 0.375, 0.25, 0., 0.125, 0.25, 0.25, 0.25, 0.125, 0., 0., -0.125, -0.125, 0.5},
        {-0.5, 0.25, 0.375, 0.125, 0., 0., 0., 0., 0., 0., 0., -0.125, -0.125, 0.5},
        {-0.5, 0.125, 0.375, 0.375, 0.25, 0.125, 0., 0., 0., 0.125, 0.125, 0., 0., 0.5},
        {-0.5, 0., 0.125, 0.25, 0.375, 0.375, 0.25, 0.25, 0.125, 0.125, 0.125, 0., 0., 0.5},
        {-0.75, -0.5, -0.5, -0.5, -0.375, -0.25, -0.25, -0.25, -0.375, -0.5, -0.5, -0.5, -0.5, 0.}}}});


    expected_gradient_weights.setValues({
      {{{18.75, 22.5, 18.75},
        {22.5, 27., 22.5},
        {18.75, 22.5, 18.75}}},
      {{{-18.75, -22.5, -18.75},
        {-22.5, -27., -22.5},
        {-18.75, -22.5, -18.75}}}});


    expected_gradient_bias.setValues({ {{{ 33., -33. }}} });
}